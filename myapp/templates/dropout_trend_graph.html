{% extends 'base.html' %}


{% block title %}
<title>Dropout Trend Graph</title>
{% endblock %}


{% block content %}
<div class="loading"><div class="loading-text">Loading ~ </div></div>
<!--All the contents go down here-->
<div class="dropout-graph-background">
    <div class="dropout-graph-layout">
        <div class="dropout-graph-container">
            <div class="dropout-graph">
                <canvas id="dropOutGraph"></canvas>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!--Link the chart.js-->
    <script>

    let graph = document.getElementById('dropOutGraph').getContext('2d');
    Chart.defaults.font.size = 16;

    let continueRate_A = JSON.parse('{{ continue_rate_A|tojson }}');
    let continueRate_B = JSON.parse('{{ continue_rate_B|tojson }}');
    let continueRate_C = JSON.parse('{{ continue_rate_C|tojson }}');
    

    let group = JSON.parse('{{ group|tojson }}');
    let labels = JSON.parse('{{ labels|tojson }}');
    let start_year = JSON.parse('{{ start_year|tojson }}');

    let curve_B = JSON.parse('{{ appliable_B|tojson }}');
    let curve_C = JSON.parse('{{ appliable_C|tojson }}');

    let title;
    
    if (group =='continue'){
        title = 'Continue Rate Trend Graph'}
    else{
        title = 'Dropout Rate Trend Graph'};

    let datasets = [];
    if (group =='continue'){
        datasets.push({
                        label: 'Continue Rate Percentage -- Curve 1',
                        data: continueRate_A,
                        borderWidth: 3,
                        hoverBorderWidth:5,
                        hoverBorderColor: '#238fb6'
                    })
                }
    else{
        let dropoutRates_A = continueRate_A.map((value) => (value !== null ? 100 - value : null));
        datasets.push({
                        label: 'Dropout Rate Percentage -- Curve 1',
                        data: dropoutRates_A,
                        borderWidth: 3,
                        hoverBorderWidth:5,
                        hoverBorderColor: '#238fb6'
                    })
        };

    if (curve_B){
        if (group =='continue'){
            datasets.push({
                            label: 'Continue Rate Percentage -- Curve 2',
                            data: continueRate_B,
                            borderWidth: 3,
                            hoverBorderWidth:5,
                            hoverBorderColor: '#238fb6'
                        })
                    }
        else{
            let dropoutRates_B = continueRate_B.map((value) => (value !== null ? 100 - value : null));
            datasets.push({
                            label: 'Dropout Rate Percentage -- Curve 2',
                            data: dropoutRates_B,
                            borderWidth: 3,
                            hoverBorderWidth:5,
                            hoverBorderColor: '#238fb6'
                        })
            }
    };


    if (curve_C){
        if (group =='continue'){
            datasets.push({
                            label: 'Continue Rate Percentage -- Curve 3',
                            data: continueRate_C,
                            borderWidth: 3,
                            hoverBorderWidth:5,
                        })
                    }
        else{
            let dropoutRates_C = continueRate_C.map((value) => (value !== null ? 100 - value : null));
            datasets.push({
                            label: 'Dropout Rate Percentage -- Curve 3',
                            data: dropoutRates_C,
                            borderWidth: 3,
                            hoverBorderWidth:5,
                        })
            }
    };


    let testingGraph = new Chart(graph, 
    {type: 'line',
    data: {labels: labels,
        datasets: datasets},
    options: {
        //intersection with mode index can give labels for both point at the same time//
        interaction: {
            mode: 'index',
            intersect: false,
        },
        
        plugins: {
            title: {
                display: true,
                text: title,
                font: {
                    size: 30
                }
            },
            legend:{
                labels:{
                    font:{
                        size:10
                    }
                },
            }
        },
        scales:{
                x:{
                    ticks:{
                        callback: function (value){
                            return value + start_year;// Extract the year part from the label and return it
                            },
                        }
                    },
                y:{
                    ticks:{
                        callback: function (value){
                            return value + '%'; // Add the percentage symbol to the labels
                            },
                        },
                        suggestedMin: 0, // minimum 0%
                        suggestedMax: 100 // maximum 100%
                    }
                    
                }
    },

    
    });
    </script>

    
    <div class="dropout-table-container">
        {{all_start_student_list_A}}
    <!-- A table that can show the data in a graph -->
    <h2>All student who took {{start_course}} and their status on {{end_course}}</h2>
    <table>
        <tbody>
            <thead>
                <tr>
                    <th>Year when taken {{start_course}}</th>
                    <th>Status for {{end_course}} (dropped out/continued)</th>
                    <th>Name (unique id)</th>
                    <th>Gender</th>
                    <th>Ethnicity</th>
                    <th>Attendance</th>
                </tr>
            </thead>

            <!-- The information for curve A -->
            {% if ethnicity_A|length == 0 %}
                <tr>
                    <td colspan="6" class="td-title" style="background-color: #92d0fad5">All Ethnicities</td>
                </tr>

            {% elif 'all' in ethnicity_A %}
                <tr>
                    <td colspan="6" class="td-title" style="background-color: #92d0fad5">All Ethnicities</td>
                </tr>

            {% else %}
                <tr>
                    <td colspan="6" class="td-title" style="background-color: #92d0fad5">
                        {% for i in range(ethnicity_A|length) %}
                            {{ ethnicity_A[i] }}
                            {% if i != ethnicity_A|length - 1 %} &{% endif %}
                        {% endfor %}
                    </td>
                </tr>
                <!-- Example output: "NZ European & Maori & African & French & Others" -->
            {% endif %}

            <!--curve_A_information[0] is a list of year of the students (interested group)
            curve_A_information[1] is a list of sql item e.g. [ <candidate 134>, <candidate 279> ]

            curve_A_information[2] is a list of year of the students (uninterested group)
            curve_A_information[3] is also a list of sql item e.g. [ <candidate 134>, <candidate 279> ]
            -->
            
            {% for student in curve_A_student %}
                <tr>
                    <td>{{student[0]}}</td>
                    <td>{{student[1]}}</td>
                    <td>{{student[2]}}</td>
                    <td>{{student[3]}}</td>
                    <td>{{student[4]}}</td>
                    <td>{{student[5]}}</td>
                </tr>
            {% endfor %}



            <!-- If there is a curve B, then apply the same thing to curve B -->
            {% if appliable_B %}
                <!-- First show the title -->
                {% if ethnicity_B|length == 0 %}
                    <tr>
                        <td colspan="6" class="td-title" style="background-color: #ffa0b4">All Ethnicities</td>
                    </tr>

                {% elif 'all' in ethnicity_B %}
                    <tr>
                        <td colspan="6" class="td-title" style="background-color: #ffa0b4">All Ethnicities</td>
                    </tr>

                {% else %}
                    <tr>
                        <td colspan="6" class="td-title" style="background-color: #ffa0b4">
                            {% for i in range(ethnicity_B|length) %}
                                {{ ethnicity_B[i] }}
                                {% if i != ethnicity_B|length - 1 %} &{% endif %}
                            {% endfor %}
                        </td>
                    </tr>
                    <!-- Example output: "NZ European & Maori & African & French & Others" -->
                {% endif %}

                {% for student in curve_B_student %}
                    <tr>
                        <td>{{student[0]}}</td>
                        <td>{{student[1]}}</td>
                        <td>{{student[2]}}</td>
                        <td>{{student[3]}}</td>
                        <td>{{student[4]}}</td>
                        <td>{{student[5]}}</td>
                    </tr>
                {% endfor %}

            {% endif %}

            <!-- If there is a curve C, then apply the same thing to curve C -->
            {% if appliable_C %}
                <!-- Get the title for curve C-->
                {% if ethnicity_C|length == 0 %}
                    <tr>
                        <td colspan="6" class="td-title" style="background-color: #ffc389">All Ethnicities</td>
                    </tr>

                    {% elif 'all' in ethnicity_C %}
                        <tr>
                            <td colspan="6" class="td-title" style="background-color: #ffc389">All Ethnicities</td>
                        </tr>

                    {% else %}
                        <tr>
                            <td colspan="6" class="td-title" style="background-color: #ffc389">
                                {% for i in range(ethnicity_C|length) %}
                                    {{ ethnicity_C[i] }}
                                    {% if i != ethnicity_C|length - 1 %} &{% endif %}
                                {% endfor %}
                            </td>
                        </tr>
                        <!-- Example output: "NZ European & Maori & African & French & Others" -->
                {% endif %}


                {% for student in curve_C_student %}
                    <tr>
                        <td>{{student[0]}}</td>
                        <td>{{student[1]}}</td>
                        <td>{{student[2]}}</td>
                        <td>{{student[3]}}</td>
                        <td>{{student[4]}}</td>
                        <td>{{student[5]}}</td>
                    </tr>
                {% endfor %}
            {% endif %}

        </tbody>
    </table>
    </div>
</div>

{% endblock %}